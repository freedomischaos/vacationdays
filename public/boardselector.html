<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Vacation Days</title>
            <link rel="stylesheet" href="/css/styles.css" type="text/css" />
            <link rel="stylesheet" href="/css/boardselector.css" type="text/css" />
    </head>
    <body>
        <div class="login-container">
            <h1>DumbKan</h1>
            <form id="pin-form" class="pin-form">
                <h2>Enter PIN</h2>
                <div class="pin-input-container">
                </div>
                <p id="pin-error" class="pin-error">Invalid PIN. Please try again.</p>
            </form>
        </div>
        <script>
            // Check if PIN is required and get length
            async function checkPinRequired() {
                const response = await fetch('/api/pin-required');
                const { required, length } = await response.json();
                if (required) {
                    const container = document.querySelector('.pin-input-container');
                    container.innerHTML = ''; // Clear existing inputs
                    
                    // Create inputs based on PIN length
                    for (let i = 0; i < length; i++) {
                        const input = document.createElement('input');
                        input.type = 'password';
                        input.className = 'pin-input';
                        input.maxLength = 1;
                        input.pattern = '[0-9]';
                        input.inputMode = 'numeric';
                        input.required = true;
                        container.appendChild(input);
                    }
                    
                    setupPinInputs();
                    document.querySelector('.pin-input').focus();
                } else {
                    window.location.href = '/';
                }
            }

            function setupPinInputs() {
                document.querySelectorAll('.pin-input').forEach((input, index, inputs) => {
                    input.addEventListener('input', (e) => {
                        if (e.target.value) {
                            e.target.classList.add('has-value');
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            } else {
                                document.getElementById('pin-form').requestSubmit();
                            }
                        } else {
                            e.target.classList.remove('has-value');
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            const prevInput = inputs[index - 1];
                            prevInput.value = '';
                            prevInput.classList.remove('has-value');
                            prevInput.focus();
                        }
                    });
                });
            }

            document.getElementById('pin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const inputs = [...document.querySelectorAll('.pin-input')];
                const pin = inputs.map(input => input.value).join('');

                            try {
                                const response = await fetch('/api/verify-pin', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ pin })
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok) {
                                    window.location.href = '/';
                                } else {
                                    const errorElement = document.getElementById('pin-error');
                                    if (response.status === 429) {
                                        errorElement.textContent = data.error;
                                    } else {
                                        const msg = 'Invalid PIN. ' + data.attemptsLeft + ' attempts remaining';
                                        errorElement.textContent = msg;
                                    }
                                    errorElement.style.display = 'block';
                                    
                                    // Reset all PIN input boxes
                                    const pinInputs = document.querySelectorAll('.pin-input');
                                    pinInputs.forEach(input => {
                                        input.value = '';
                                        input.classList.remove('has-value');
                                    });
                                    // Focus the first input box
                                    pinInputs[0].focus();
                                }
                            } catch (error) {
                                console.error('Error verifying PIN:', error);
                                document.getElementById('pin-error').style.display = 'block';
                            }
                });

            checkPinRequired();
        </script>
    </body>
    </html>